<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Osiris-Chat ðŸ’¬</title>
    <style>
        body.theme-dark {
            font-family: Arial, sans-serif;
            background: #222;
            color: #fff;
        }

        body.theme-dark #chat {
            background: #333;
        }

        body.theme-dark #messages li {
            background: #444;
            color: #fff;
        }

        body.theme-light {
            font-family: Arial, sans-serif;
            background: #f5f5f5;
            color: #222;
        }

        body.theme-light #chat {
            background: #fff;
        }

        body.theme-light #messages li {
            background: #e0e0e0;
            color: #222;
        }

        body.theme-blue {
            font-family: Arial, sans-serif;
            background: #0d1a2b;
            color: #e3f2fd;
        }

        body.theme-blue #chat {
            background: #1565c0;
        }

        body.theme-blue #messages li {
            background: #1976d2;
            color: #e3f2fd;
        }

        #chat {
            max-width: 500px;
            margin: 40px auto;
            padding: 20px;
            border-radius: 8px;
        }

        #messages {
            list-style: none;
            padding: 0;
            margin-bottom: 20px;
        }

        #messages li {
            padding: 8px 10px;
            margin-bottom: 4px;
            border-radius: 4px;
        }

        #form {
            display: flex;
        }

        #input {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 4px;
        }

        #send {
            padding: 10px 20px;
            border: none;
            background: #00bfa5;
            color: #fff;
            border-radius: 4px;
            cursor: pointer;
        }

        #send:hover {
            background: #009e88;
        }
    </style>
</head>

<body>
    <div id="theme-controls" style="margin: 20px auto; max-width: 500px;">
        <label for="theme-select">Tema:</label>
        <select id="theme-select">
            <option value="dark">Oscuro</option>
            <option value="light">Claro</option>
            <option value="blue">Azul</option>
        </select>
    </div>
    <div id="chat">
        <h2>Osiris-Chat ðŸ’¬</h2>
        <div id="user-controls" style="margin-bottom:10px;">
            <label for="user-list">Usuarios conectados:</label>
            <select id="user-list"></select>
            <input id="private-msg" placeholder="Mensaje privado..." style="width:120px;" />
            <button id="send-private" type="button">Enviar privado</button>
        </div>
        <div id="room-controls" style="margin-bottom:10px;">
            <select id="room-list"></select>
            <input id="new-room" placeholder="Nueva sala..." style="width:120px;" />
            <button id="create-room" type="button">Crear sala</button>
        </div>
        <ul id="messages"></ul>
        <form id="form" autocomplete="off" style="margin-bottom:10px;">
            <input id="input" placeholder="Escribe tu mensaje..." />
            <button id="send" type="submit">Enviar</button>
        </form>
        <div id="emoji-picker" style="margin-bottom:10px; display:none;"></div>
        <div id="username-container">
            <input id="username" placeholder="Tu nombre de usuario" />
            <button id="set-username">Entrar al chat</button>
        </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        const userList = document.getElementById('user-list');
        const privateMsgInput = document.getElementById('private-msg');
        const sendPrivateBtn = document.getElementById('send-private');
        const socket = io();
        const roomList = document.getElementById('room-list');
        const newRoomInput = document.getElementById('new-room');
        const createRoomBtn = document.getElementById('create-room');

        // Cambiar de sala
        roomList.onchange = function () {
            socket.emit('join room', roomList.value);
        };

        // Crear nueva sala
        createRoomBtn.onclick = function () {
            const roomName = newRoomInput.value.trim();
            if (roomName) {
                socket.emit('create room', roomName);
                socket.emit('join room', roomName);
                newRoomInput.value = '';
            }
        };

        // Actualizar lista de salas
        socket.on('room list', function (rooms) {
            // Actualizar lista de usuarios conectados
            socket.on('user list', function (users) {
                userList.innerHTML = '';
                users.forEach(function (user) {
                    const option = document.createElement('option');
                    option.value = user;
                    option.textContent = user;
                    userList.appendChild(option);
                });
                // El primer usuario es admin
                if (users[0] === username) {
                    isAdmin = true;
                } else {
                    isAdmin = false;
                }
            });

            // Enviar mensaje privado
            sendPrivateBtn.onclick = function () {
                const toUser = userList.value;
                const msg = privateMsgInput.value.trim();
                if (toUser && msg) {
                    socket.emit('private message', { to: toUser, msg });
                    addMessage('TÃº â†’ ' + toUser, msg, true);
                    privateMsgInput.value = '';
                }
            };

            // Recibir mensaje privado
            socket.on('private message', function (data) {
                addMessage(data.from + ' (privado)', data.msg, false);
            });
            roomList.innerHTML = '';
            rooms.forEach(function (room) {
                const option = document.createElement('option');
                option.value = room;
                option.textContent = room;
                roomList.appendChild(option);
            });
        });
        const form = document.getElementById('form');
        const input = document.getElementById('input');
        const messages = document.getElementById('messages');
        const usernameInput = document.getElementById('username');
        const setUsernameBtn = document.getElementById('set-username');
        const usernameContainer = document.getElementById('username-container');
        let username = '';
        let isAdmin = false;

        // Lista de emojis populares
        const emojiList = ['ðŸ˜Š', 'ðŸ˜¢', 'ðŸ˜ƒ', 'â¤ï¸', 'ðŸ˜®', 'ðŸ˜›', 'ðŸ”¥', 'â­', 'ðŸ‘', 'ðŸ‘', 'ðŸ’¯', 'ðŸš€', 'ðŸ¥³', 'ðŸ˜‰', 'ðŸ˜­', 'ðŸ˜Ž', 'ðŸ˜¡', 'ðŸ˜´', 'ðŸ’©', 'ðŸ‘Œ', 'ðŸ‘‹', 'ðŸ™', 'ðŸ‘€', 'ðŸŒŸ', 'ðŸŽ', 'ðŸŽ‰', 'ðŸ’¤', 'â˜€ï¸', 'ðŸŒ™', 'ðŸŒˆ', 'ðŸ±', 'ðŸ¶', 'ðŸ¦„', 'ðŸŒµ', 'ðŸ•', 'ðŸ°', 'â˜•', 'ðŸº', 'âš½', 'ðŸŽµ', 'ðŸ“·', 'ðŸ“±', 'ðŸ’»', 'ðŸ“º', 'ðŸš—', 'ðŸšŒ', 'ðŸš†', 'âœˆï¸', 'ðŸ’¸', 'ðŸ’Ž', 'ðŸ‘‘', 'ðŸ‘»', 'ðŸ‘½', 'ðŸ¤–', 'ðŸŽ', 'ðŸŒ', 'ðŸ‰', 'ðŸ’', 'ðŸ‡', 'ðŸ‹', 'ðŸ‘', 'ðŸ¥‘', 'ðŸ¥¦', 'ðŸ¥•', 'ðŸŒ½', 'ðŸŒ­', 'ðŸŸ', 'ðŸ¿', 'ðŸ¦', 'ðŸ©', 'ðŸª', 'ðŸ«', 'ðŸ¥›', 'ðŸµ', 'ðŸ£', 'ðŸœ', 'ðŸ±', 'ðŸŒ®', 'ðŸŒ¯', 'ðŸ¥ª', 'ðŸ¥š', 'ðŸ¥“', 'ðŸ¤', 'ðŸ¦ž', 'ðŸ¦€', 'ðŸ™', 'ðŸŸ', 'ðŸ³', 'ðŸ¬', 'ðŸ¢', 'ðŸ¸', 'ðŸ’', 'ðŸ»', 'ðŸ¼', 'ðŸ¨', 'ðŸ°', 'ðŸ­', 'ðŸ¹', 'ðŸ¦Š', 'ðŸ¦', 'ðŸ¯', 'ðŸ´', 'ðŸ®', 'ðŸ·', 'ðŸ‘', 'ðŸ', 'ðŸ”', 'ðŸ¦†', 'ðŸ¦…', 'ðŸ¦‰', 'ðŸ§', 'ðŸ˜', 'ðŸ¦’', 'ðŸ¦“', 'ðŸ¦˜', 'ðŸ«', 'ðŸ¦›', 'ðŸ¦', 'ðŸŠ', 'ðŸ', 'ðŸ•·ï¸', 'ðŸ¦‚', 'ðŸž', 'ðŸœ', 'ðŸ', 'ðŸ¦‹', 'ðŸŒ', 'ðŸª±', 'ðŸ¦—', 'ðŸ¦Ÿ', 'ðŸª°', 'ðŸª¶', 'ðŸ•¸ï¸', 'ðŸŒ¹', 'ðŸŒ·', 'ðŸŒ»', 'ðŸŒ¼', 'ðŸ’', 'ðŸŒ¸', 'ðŸŒº', 'ðŸ', 'ðŸ‚', 'ðŸŒ¿', 'ðŸ„', 'ðŸŒ²', 'ðŸŒ´', 'ðŸŒ±', 'ðŸ¥¥', 'ðŸ', 'ðŸ¥', 'ðŸ¥­', 'ðŸ“', 'ðŸ«', 'ðŸ«’', 'ðŸ’§', 'ðŸ’¦', 'ðŸŒŠ', 'ðŸŒ‹', 'â›°ï¸', 'â„ï¸', 'â˜ï¸', 'ðŸŒ§ï¸', 'âš¡', 'ðŸŒ¬ï¸', 'ðŸŒ«ï¸', 'ðŸŒˆ', 'â˜‚ï¸', 'â›„', 'ðŸ”¥', 'â­', 'ðŸŒ™', 'â˜€ï¸', 'ðŸŒ', 'ðŸŒŽ', 'ðŸ—ºï¸', 'ðŸ§­', 'âŒš', 'â°', 'â³', 'ðŸ“…', 'ðŸ•°ï¸', 'â²ï¸', 'â±ï¸', 'ðŸŒ¡ï¸', 'ðŸ’¡', 'ðŸ”¦', 'ðŸ•¯ï¸', 'ðŸ”‹', 'ðŸ”Œ', 'ðŸ› ï¸', 'ðŸ”¨', 'ðŸ”§', 'ðŸ”©', 'âš™ï¸', 'ðŸ’£', 'ðŸ”«', 'ðŸ”ª', 'ðŸ’Š', 'ðŸ’‰', 'ðŸ¦·', 'ðŸ¦´', 'ðŸ‘€', 'ðŸ‘‚', 'ðŸ‘ƒ', 'ðŸ‘„', 'ðŸ‘…', 'ðŸ¦¶', 'ðŸ–ï¸', 'âœŠ', 'ðŸ’ª', 'ðŸ¦µ', 'ðŸ§ ', 'â¤ï¸', 'ðŸ«', 'ðŸ«ƒ', 'ðŸ¦·', 'ðŸ¦´', 'ðŸ‘ï¸', 'ðŸ‘‚', 'ðŸ‘ƒ', 'ðŸ‘„', 'ðŸ‘…', 'ðŸ¦¶', 'ðŸ–ï¸', 'âœŠ', 'ðŸ’ª', 'ðŸ¦µ', 'ðŸ§ '];
        const emojiPicker = document.getElementById('emoji-picker');
        function showEmojiPicker() {
            emojiPicker.innerHTML = '';
            emojiList.forEach(emoji => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.textContent = emoji;
                btn.style.fontSize = '20px';
                btn.style.margin = '2px';
                btn.onclick = () => {
                    input.value += emoji;
                    input.focus();
                };
                emojiPicker.appendChild(btn);
            });
            emojiPicker.style.display = 'block';
        }
        input.addEventListener('focus', showEmojiPicker);
        input.addEventListener('blur', () => {
            setTimeout(() => { emojiPicker.style.display = 'none'; }, 200);
        });

        form.style.display = 'none';

        setUsernameBtn.onclick = function () {
            if (usernameInput.value.trim()) {
                username = usernameInput.value.trim();
                socket.emit('set username', username);
                usernameContainer.style.display = 'none';
                form.style.display = 'flex';
            }
        };


        form.addEventListener('submit', function (e) {
            e.preventDefault();
            if (!username) {
                alert('Debes ingresar tu nombre de usuario antes de enviar mensajes.');
                return;
            }
            if (input.value) {
                socket.emit('chat message', input.value);
                input.value = '';
            }
        });

        function addMessage(user, msg, self) {
            const item = document.createElement('li');
            let messageText = user + ': ' + (msg.msg || msg);
            item.innerHTML = `<span>${messageText}</span>`;
            item.style.background = self ? '#00bfa5' : '#444';
            item.style.color = self ? '#222' : '#fff';
            item.style.textAlign = self ? 'right' : 'left';
            // BotÃ³n de reacciÃ³n solo si hay id de mensaje
            if (msg.id) {
                const reactBtn = document.createElement('button');
                reactBtn.textContent = 'ðŸ˜Š';
                reactBtn.style.marginLeft = '8px';
                reactBtn.onclick = function () {
                    const emoji = prompt('Elige un emoji para reaccionar:', 'ðŸ˜Š');
                    if (emoji) {
                        socket.emit('add reaction', { messageId: msg.id, emoji });
                    }
                };
                item.appendChild(reactBtn);
                // Mostrar reacciones
                if (Array.isArray(msg.reactions) && msg.reactions.length > 0) {
                    const reactsSpan = document.createElement('span');
                    reactsSpan.style.marginLeft = '8px';
                    reactsSpan.textContent = msg.reactions.map(r => r.emoji).join(' ');
                    item.appendChild(reactsSpan);
                }
                // BotÃ³n borrar mensaje (solo admin)
                if (isAdmin) {
                    const delBtn = document.createElement('button');
                    delBtn.textContent = 'ðŸ—‘ï¸';
                    delBtn.style.marginLeft = '8px';
                    delBtn.onclick = function () {
                        if (confirm('Â¿Borrar este mensaje?')) {
                            socket.emit('delete message', msg.id);
                        }
                    };
                    item.appendChild(delBtn);
                }
            }
            messages.appendChild(item);
            messages.scrollTop = messages.scrollHeight;
            // BotÃ³n expulsar usuario (solo admin)
            if (isAdmin) {
                userList.style.background = '#ffeb3b';
                userList.title = 'Selecciona usuario para expulsar';
                userList.onchange = function () {
                    const userToKick = userList.value;
                    if (userToKick && userToKick !== username) {
                        if (confirm('Â¿Expulsar a ' + userToKick + '?')) {
                            socket.emit('kick user', userToKick);
                        }
                    }
                };
            } else {
                userList.style.background = '';
                userList.title = '';
                userList.onchange = null;
            }
            socket.on('kicked', function () {
                alert('Has sido expulsado por el administrador.');
                location.reload();
            });
        }


        socket.on('chat message', function (data) {
            addMessage(data.username, data, data.username === username);
        });

        // Mostrar historial de mensajes al entrar
        socket.on('chat history', function (history) {
            messages.innerHTML = '';
            history.forEach(function (data) {
                addMessage(data.username, data, false);
            });
        });
        // Actualizar reacciones en tiempo real
        socket.on('update reactions', function ({ messageId, reactions }) {
            // Buscar el mensaje en la lista y actualizar reacciones
            const items = messages.querySelectorAll('li');
            items.forEach(item => {
                if (item.innerHTML.includes(messageId)) {
                    // Actualizar reacciones
                    let reactsSpan = item.querySelector('.reactions');
                    if (!reactsSpan) {
                        reactsSpan = document.createElement('span');
                        reactsSpan.className = 'reactions';
                        item.appendChild(reactsSpan);
                    }
                    reactsSpan.textContent = reactions.map(r => r.emoji).join(' ');
                }
            });
        });

        socket.on('user connected', function (user) {
            const item = document.createElement('li');
            item.textContent = 'ðŸŸ¢ ' + user + ' se ha conectado.';
            item.style.fontStyle = 'italic';
            item.style.color = '#00bfa5';
            item.style.background = '#222';
            item.style.textAlign = 'center';
            messages.appendChild(item);
            messages.scrollTop = messages.scrollHeight;
        });

        socket.on('user disconnected', function (user) {
            const item = document.createElement('li');
            item.textContent = 'ðŸ”´ ' + user + ' se ha desconectado.';
            item.style.fontStyle = 'italic';
            item.style.color = '#ff5252';
            item.style.background = '#222';
            item.style.textAlign = 'center';
            messages.appendChild(item);
            messages.scrollTop = messages.scrollHeight;
        });
    </script>
    <script>
        // --- Cambio de tema ---
        const themeSelect = document.getElementById('theme-select');
        function setTheme(theme) {
            document.body.className = 'theme-' + theme;
            localStorage.setItem('chatTheme', theme);
        }
        themeSelect.addEventListener('change', function () {
            setTheme(themeSelect.value);
        });
        // Cargar tema guardado al iniciar
        const savedTheme = localStorage.getItem('chatTheme') || 'dark';
        themeSelect.value = savedTheme;
        setTheme(savedTheme);
    </script>
</body>

</html>